<%- include('../layout/header.ejs') %>
    <%- include('../layout/aside.ejs') %>
        <div class="content-wrapper" style="min-height: 946px;">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    Text Editors
                    <small>Advanced form element</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                    <li><a href="#">Forms</a></li>
                    <li class="active">Editors</li>
                </ol>
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="row">

                    <div class="col-md-12">
                        <div class="box box-warning">
                            <div class="box-header with-border">
                                <h3 class="box-title">images products</h3>
                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                            class="fa fa-minus"></i>
                                    </button>
                                </div>

                            </div>

                            <div class="box-body"
                                style=" display: flex; margin: 0; padding: 0; flex-wrap: wrap; justify-content: center;   ">

                                <input type="text" id="cachCuChuoi" value="<%= productData.IDProduct%>"
                                    style="display: none;">


                                <% image.forEach((element, index)=> { %>
                                    <div class="card" style="width: 32rem; border: 1px solid #000; margin: 10px;">
                                        <label for="exampleInputImage" style="width: 100%;">
                                            <img src="<%= element.UrlImages ? element.UrlImages : '' %>"
                                                style="width: 100%; height: 400px;" class="card-img-top-1" alt="...">
                                        </label>
                                        <input type="file" style="display: none;" id="exampleInputImage">
                                        <div class="card-body">
                                            <button>delete</button>
                                            <button>update</button>
                                        </div>
                                    </div>
                                    <% }); %>






                                        <div class="card" style="width: 32rem;  border: 1px solid #000; margin: 10px;">
                                            <img src="http://localhost:8082/congkhai/img_products/them%20anh.jpg"
                                                style="width: 100%; height: 400px;" class="card-img-top-2" alt="...">

                                            <div class="card-body" style="display: flex;">

                                                <input type="file" style="display: none;" id="file-upload">

                                                <label id="file-upload-label" for="file-upload" style="border: 1px solid #ccc; display: inline-block; padding: 6px 12px;
                                                cursor: pointer; background-color: #f8f9fa; 
                                                color: #495057; border-radius: 4px; 
                                                font-size: 16px; justify-content: center; align-items: center;">
                                                    <i class="fa fa-cloud-upload"></i> Upload image
                                                </label>
                                            </div>
                                        </div>

                            </div>

                        </div>

                    </div>


                    <div class="col-md-12">
                        <div class="box box-info">
                            <div class="box-header">
                                <h3 class="box-title">ProductDescription</h3>
                                <!-- tools box -->
                                <div class="pull-right box-tools">
                                    <button type="button" class="btn btn-info btn-sm" data-widget="collapse"
                                        data-toggle="tooltip" title="Collapse">
                                        <i class="fa fa-minus"></i></button>

                                </div>
                                <!-- /. tools -->
                            </div>
                            <!-- /.box-header -->


                            <!-- description -->
                            <div class="box-body pad">
                                <form>
                                    <textarea class="noi-dung-summernote-editer" name="editor1" rows="10" cols="80"
                                        style="visibility: hidden; display: none;">
                                        <%= productData.ProductDescription %>
                                    </textarea>
                                </form>
                            </div>


                        </div>
                        <!-- /.box -->

                        <form
                            action="https://thoitrangdarkt-com.onrender.com/api/v1/update-product/<%= productData.id%>"
                            method="post" enctype="multipart/form-data">


                            <!-- image old -->
                            <input type="text" hidden value="<%= productData.image%>" name="image_old">


                            <!-- name -->
                            <div class="form-group">
                                <label for="exampleInputPassword1">ProductName</label>
                                <input name="name" type="text" class="form-control" id="exampleInputname1"
                                    value="<%= productData.ProductName %>">
                            </div>

                            <!-- price -->
                            <div class="form-group">
                                <label for="exampleInputPassword1">Price</label>
                                <input name="price" type="text" class="form-control" id="priceInput"
                                    value="<%= productData.Price %>">
                            </div>

                            <!-- sale_price -->
                            <div class="form-group">
                                <label for="exampleInputPassword1">Sale</label>
                                <input name="sale_price" type="text" class="form-control" id="salePriceInput"
                                    value="<%= productData.Sale %>">
                            </div>

                            <!-- category -->
                            <div class="form-group">
                                <label for="exampleInputPassword1">product type</label>
                                <select name="category" id="categorySelect" class="form-control">
                                    <option>chọn danh mục</option>
                                    <% categoryData.map((item)=> { %>
                                        <option value="<%= item.IDProductType %>"
                                            <%=item.IDProductType===productData.IDProductType ? 'selected' : '' %>>
                                            <%= item.ProductTypeName%>

                                        </option>
                                        <% }) %>
                                </select>
                            </div>


                            <!-- supplier -->
                            <div class="form-group">
                                <label for="exampleInputPassword1">Supplier</label>
                                <select name="category" id="supplierSelect" class="form-control">
                                    <option>chọn nhà cung cấp</option>
                                    <% supplierData.map((item)=> { %>
                                        <option value="<%= item.IDSupplier %>"
                                            <%=item.IDSupplier===productData.IDSupplier ? 'selected' : '' %>>
                                            <%= item.SupplierName %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>


                            <!-- radio -->
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="exampleRadios1" value="1"
                                    <%=productData.Status===1 ? 'checked' : '' %>>
                                <label class="form-check-label" for="exampleRadios1">
                                    hiển thị
                                </label>
                            </div>

                            <div class="form-check" style="margin-bottom: 30px;">
                                <input class="form-check-input" type="radio" name="status" id="exampleRadios2" value="0"
                                    <%=productData.Status===0 ? 'checked' : '' %>>
                                <label class="form-check-label" for="exampleRadios2">
                                    tạm ẩn
                                </label>
                            </div>




                            <!-- button submit -->
                            <button type="submit" class="btn btn-primary btnSubmit"><i class="fa fa-save"></i>
                                Submit</button>
                            <a href="http://localhost:8082/admin/v1/product" class="btn btn-default"><i
                                    class="fa fa-arrow-left"></i> Trở lại</a>

                        </form>
                    </div>

                    <!-- /.col-->
                </div>
                <!-- ./row -->
            </section>
            <!-- /.content -->
        </div>
        <%- include('../layout/footer.ejs')%>

            <script>

           
               
        


                // update static
                document.getElementById('file-upload').addEventListener("change", async (e) => {
                    const selectedFile = event.target.files[0];
                    console.log(selectedFile)
                    try {
                            const response = await fetch(`http://localhost:8082/admin/v1/cloudinary-upload`, {
                                method: 'POST',
                                body: selectedFile,
                                headers: {
                                    'Content-Type': 'image/jpeg', 
                                },
                            });
                            if (response.ok) {
                                const responseData = await response.json();
                                alert(responseData.message);
                            } else {
                                const errorMessage = await response.text();
                                alert(errorMessage);
                                console.error('Failed to upload file:', response.statusText);
                            }
                        } catch (error) {
                            console.error('Error during fetch:', error);
                        }



                    // const reader = new FileReader();
                    // reader.onload = function (event) {
                    //     const imageUrl = event.target.result;
                    //     document.querySelector(".card-img-top-2").src = imageUrl
                    // };

                    // reader.readAsDataURL(selectedFile);
                })

                // btnSumbit

                const postRequired = async (requestBody) => {
                    try {
                        const response = await fetch(`http://localhost:8082/admin/v1/product/edit/${document.querySelector("#cachCuChuoi").value.trim()}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody),
                        });

                        // Check if the request was successful (status code 2xx)
                        if (response.ok) {
                            const responseData = await response.json();
                            alert(responseData.message);
                            window.location.href = 'http://localhost:8082/admin/v1/producttype';
                        } else if (response.status === 404) {
                            const responseData = await response.json();
                            alert(responseData.message);
                        } else if (response.status === 400) {
                            const responseData = await response.json();
                            alert(responseData.message);
                        } else if (response.status == 500) {
                            const responseData = await response.json();
                            alert(responseData.message);
                        }
                        else {
                            console.error('Failed to create user:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error during fetch:', error);
                    }
                }

                // check empty
                const checkEmpty = () => {
                    let name = document.querySelector("#exampleInputname1");
                    const price = document.querySelector("#priceInput");
                    const sale_price = document.querySelector("#salePriceInput");
                    const radio1 = document.querySelector("#exampleRadios1");
                    const radio2 = document.querySelector("#exampleRadios2");
                    const categorySelect = document.querySelector("#categorySelect");
                    const supplierSelect = document.querySelector("#supplierSelect");
                    const description = document.querySelector("#editor1");
                    const image = document.getElementById("pro-img");
                    if (name.value == "" || radio1.checked == false && radio2.checked == false
                        || sale_price.value == "" || price.value == "" || categorySelect.value == "chọn danh mục"
                        || supplierSelect.value == "chọn nhà cung cấp" || description.value.trim() == ""
                        || image.src == "http://localhost:8082/admin/v1/product/edit/123") {
                        return false;
                    }
                    return true;
                }


                // btn click submit
                let btn_submit = document.querySelector(".btnSubmit");
                btn_submit.addEventListener("click", async (e) => {
                    e.preventDefault();
                    if (checkEmpty() == false) {
                        alert("Không để trống thông tin");
                    } else {

                        let name = document.querySelector("#exampleInputname1");
                        const price = document.querySelector("#priceInput");
                        const sale_price = document.querySelector("#salePriceInput");
                        const radio1 = document.querySelector("#exampleRadios1");
                        const radio2 = document.querySelector("#exampleRadios2");
                        const categorySelect = document.querySelector("#categorySelect");
                        const supplierSelect = document.querySelector("#supplierSelect");
                        const description = document.querySelector("#editor1");
                        const image = document.getElementById("pro-img");

                        const exampleData = {
                            ProductDescription: description.value,
                            ProductName: name.value,
                            Price: price.value,
                            sale: sale_price.value,
                            productType: categorySelect.value,
                            Supplier: supplierSelect.value,
                            radio: radio1.checked == true ? 1 : 0,

                        };

                        await postRequired(exampleData);

                        document.querySelector("#exampleRadios1").checked = true
                        document.querySelector("#exampleRadios2").checked = false
                    }
                });


                function showImage(image) {
                    var file = image.files[0];
                    console.log(file.name)
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('pro-img').src = e.target.result;
                    }
                    reader.readAsDataURL(file);
                }

            </script>